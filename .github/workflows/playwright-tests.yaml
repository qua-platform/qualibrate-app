name: Playwright Tests

on:
  push:
    branches:
      - main
      - integration
  pull_request:
    branches:
      - main
      - integration

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout the main repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Use Node.js
        id: node-setup
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - uses: actions/cache@v4
        id: frontend-cache-id
        with:
          path: frontend/node_modules
          key: npm-${{ hashFiles('frontend/**/package-lock.json') }}
          restore-keys: npm-

      - name: Install npm deps
        if: steps.frontend-cache-id.outputs.cache-hit != 'true'
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          # cache: "poetry"
          # cache-dependency-path: backend/poetry.lock

      - name: Copy built FE to BE
        run: cp -r frontend/dist backend/qualibrate_static

      - name: Install qualibrate-app
        run: pip install .
        working-directory: backend
      #   poetry install

      - name: Install qualibrate-core and qualibrate-runner and qualibrate-composite
        run: pip install git+https://github.com/qua-platform/qualibrate-runner.git \
          git+https://github.com/qua-platform/qualibrate-core.git \
          git+https://github.com/qua-platform/qualibrate.git
      # Checkout the private calibration scripts repository
      - name: Checkout Calibration Scripts
        uses: actions/checkout@v4
        with:
          repository: 'qua-platform/qualibrate-examples'
          path: 'qualibrate-examples'
          token: ${{ secrets.QUALIBRATION_EXAMPLES_TOKEN }}

      - name: Install Playwright Test Dependencies
        run: pip install quam xarray

      - name: Create directory for user storage
        run: mkdir -p data

      # Create Qualibrate Configuration
      - name: Create Qualibrate Configuration
        run: |
          qualibrate config --auto-accept \
            --runner-calibration-library-folder $GITHUB_WORKSPACE/qualibrate-examples/calibrations \
            --app-user-storage $GITHUB_WORKSPACE/data
          # Uncomment the line below to debug the configuration file
        #   cat /root/.qualibrate/config.toml
        #   ls $GITHUB_WORKSPACE/qualibrate-examples/calibrations 

      # Install Node.js and Playwright
      - name: Install Playwright Dependencies
        working-directory: ./frontend/tests
        run: |
          npm install
          # npx playwright install --with-deps
          npx playwright install-deps chromium # chrome only for now 
          npx playwright install chromium

      # Start Qualibrate Server
      - name: Start Qualibrate Server
        run: |
          nohup qualibrate start > qualibrate-server.log 2>&1 &
          for i in {1..15}; do
            if curl -s http://localhost:8001/ > /dev/null; then
              echo "Server is up and running"
              break
            fi
            echo "Waiting for server to start..."
            sleep 2
          done
          curl -v http://localhost:8001/

      # Run Playwright Tests
      - name: Run Playwright Tests
        working-directory: ./frontend/tests/e2e
        run: |
          npx playwright test
